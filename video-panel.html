<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Favicon -->
<link rel="icon" type="image/png" href="img/Logo.png">
<link rel="apple-touch-icon" href="img/Logo.png">
<title>Camera Panel - Karaoke Bus</title>
<link rel="stylesheet" href="css/video-panel.css">
</head>
<body>
<div class="container">
<!-- Header -->
<div class="header">
<!-- âœ… BACK BUTTON (SIMPLE) -->
<a href="#" id="back-btn" class="back-button">
<span>â†</span>
<span>Kembali</span>
</a>
<h1>ğŸ¥ Camera Panel</h1>
<p class="subtitle">Streaming ke Display Bus</p>
<!-- âœ… LOGOUT BUTTON (SIMPLE) -->
<button id="logout-btn" class="logout-button">
<span>ğŸšª</span>
<span>Logout</span>
</button>
</div>

<!-- Camera Preview -->
<div class="camera-preview" id="camera-preview">
<video id="local-video" autoplay playsinline muted></video>
<div class="camera-overlay" id="camera-overlay">
<div class="overlay-message">
<span class="icon">ğŸ“·</span>
<p>Kamera Belum Aktif</p>
<!-- âœ… START CAMERA BUTTON (SIMPLE) -->
<button class="btn-primary" id="start-camera-btn">Aktifkan Kamera</button>
</div>
</div>
</div>

<!-- Controls -->
<div class="controls-panel">
<div class="status-bar">
<div class="status-item">
<span class="label">Status:</span>
<span class="value" id="connection-status">Offline</span>
<span class="status-dot" id="status-dot"></span>
</div>
<div class="status-item">
<span class="label">Streaming:</span>
<span class="value" id="streaming-status">Tidak Aktif</span>
</div>
<div class="status-item" id="recording-status-bar" style="display: none;">
<span class="label">Recording:</span>
<span class="value recording-time" id="recording-time">00:00</span>
</div>
</div>

<div class="control-buttons">
<!-- âœ… FLIP BUTTON (SIMPLE) -->
<button class="control-btn secondary" id="flip-camera-btn" title="Balik Kamera" disabled>
<span>ğŸ”„</span>
<span>Balik Kamera</span>
</button>
<!-- âœ… RECORD BUTTON (SIMPLE) -->
<button class="control-btn primary" id="record-btn" title="Mulai Rekam" disabled>
<span id="record-icon">âºï¸</span>
<span id="record-text">Mulai Rekam</span>
</button>
<!-- âœ… STOP BUTTON (SIMPLE) -->
<button class="control-btn danger" id="stop-camera-btn" title="Stop Kamera" style="display: none;">
<span>â¹ï¸</span>
<span>Stop Kamera</span>
</button>
</div>
</div>
</div>

<!-- âœ… SCRIPTS IN CORRECT ORDER -->

<!-- 1. Custom Modal -->
<script src="js/custom-modal.js"></script>

<!-- 2. Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- 3. Firebase Config -->
<script src="js/firebase.js"></script>

<!-- 4. Room Manager -->
<script src="js/room.js"></script>

<!-- 5. Security Check -->
<script src="js/video-panel-page.js"></script>

<!-- 6. Main Logic -->
<script src="js/video-panel.js"></script>

<!-- 7. Event Handlers (Simple & Clean) -->
<script>
console.log('ğŸ”§ Setting up event handlers...');

// Wait for DOM to be ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupEventHandlers);
} else {
  setupEventHandlers();
}

function setupEventHandlers() {
  console.log('ğŸ“ Setting up all button handlers...');
  
  // ========= START CAMERA BUTTON =========
  const startBtn = document.getElementById('start-camera-btn');
  if (startBtn) {
    startBtn.addEventListener('click', function() {
      console.log('ğŸ¬ START CAMERA BUTTON CLICKED!');
      
      if (typeof window.startCamera === 'function') {
        console.log('âœ… Calling window.startCamera()');
        window.startCamera();
      } else {
        console.error('âŒ window.startCamera not found!');
        alert('âš ï¸ Fungsi kamera belum siap.\n\nSolusi:\n1. Refresh halaman (F5)\n2. Tunggu beberapa detik\n3. Coba lagi');
      }
    });
    console.log('âœ… Start camera button handler attached');
  } else {
    console.error('âŒ Start camera button not found!');
  }
  
  // ========= STOP CAMERA BUTTON =========
  const stopBtn = document.getElementById('stop-camera-btn');
  if (stopBtn) {
    stopBtn.addEventListener('click', function() {
      console.log('â¹ï¸ STOP CAMERA BUTTON CLICKED!');
      if (typeof window.stopCamera === 'function') {
        window.stopCamera();
      }
    });
    console.log('âœ… Stop camera button handler attached');
  }
  
  // ========= FLIP CAMERA BUTTON =========
  const flipBtn = document.getElementById('flip-camera-btn');
  if (flipBtn) {
    flipBtn.addEventListener('click', function() {
      console.log('ğŸ”„ FLIP CAMERA BUTTON CLICKED!');
      if (typeof window.flipCamera === 'function') {
        window.flipCamera();
      }
    });
    console.log('âœ… Flip camera button handler attached');
  }
  
  // ========= RECORD BUTTON =========
  const recordBtn = document.getElementById('record-btn');
  if (recordBtn) {
    recordBtn.addEventListener('click', function() {
      console.log('âºï¸ RECORD BUTTON CLICKED!');
      if (typeof window.toggleRecording === 'function') {
        window.toggleRecording();
      }
    });
    console.log('âœ… Record button handler attached');
  }
  
  // ========= LOGOUT BUTTON =========
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('ğŸšª LOGOUT BUTTON CLICKED!');
      if (typeof window.logout === 'function') {
        window.logout();
      }
    });
    console.log('âœ… Logout button handler attached');
  }
  
  // ========= BACK BUTTON =========
  const backBtn = document.getElementById('back-btn');
  if (backBtn) {
    backBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      console.log('â—€ï¸ BACK BUTTON CLICKED!');
      
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('room');
      
      if (!roomId) {
        console.error('âŒ No room ID');
        window.location.href = 'index.html';
        return;
      }
      
      console.log('ğŸ“ Room ID:', roomId);
      
      // Check if camera is active
      const cameraActive = window.isCameraActive || false;
      
      if (cameraActive) {
        let confirmBack;
        if (typeof customConfirm === 'function') {
          confirmBack = await customConfirm(
            'Kamera sedang aktif. Yakin ingin keluar?\n\nKamera akan dimatikan otomatis.',
            {
              title: 'âš ï¸ Keluar?',
              confirmText: 'Ya, Keluar',
              cancelText: 'Batal',
              confirmClass: 'custom-modal-btn-danger'
            }
          );
        } else {
          confirmBack = confirm('Kamera aktif. Yakin keluar?');
        }
        
        if (!confirmBack) {
          console.log('âŒ User cancelled back action');
          return;
        }
        
        // Stop camera before leaving
        if (typeof window.stopCamera === 'function') {
          try {
            console.log('â¹ï¸ Stopping camera before exit...');
            // Just stop, don't wait for confirmation
            if (window.localStream) {
              window.localStream.getTracks().forEach(t => t.stop());
            }
          } catch (e) {
            console.log('âš ï¸ Stop error (ignoring):', e);
          }
        }
      }
      
      // Redirect to bus menu
      console.log('ğŸ”„ Redirecting to bus menu...');
      window.location.href = `bus-menu.html?room=${roomId}`;
    });
    console.log('âœ… Back button handler attached');
  }
  
  console.log('âœ…âœ…âœ… All event handlers ready!');
}
</script>

</body>
</html>