<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Masuk ke Bus - Karaoke Bus</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
font-family: Arial, sans-serif;
background: linear-gradient(135deg, #667eea, #764ba2);
height: 100vh;
display: flex;
justify-content: center;
align-items: center;
margin: 0;
}
.card {
background: #fff;
padding: 40px;
border-radius: 20px;
width: 100%;
max-width: 360px;
box-shadow: 0 20px 50px rgba(0,0,0,.3);
text-align: center;
}
h1 { margin-bottom: 20px; color: #333; }
p { color: #666; margin-bottom: 20px; }
input {
width: 100%;
padding: 15px;
border-radius: 12px;
border: 1px solid #ccc;
font-size: 24px;
text-align: center;
letter-spacing: 8px;
margin-bottom: 20px;
box-sizing: border-box;
}
button {
width: 100%;
padding: 15px;
background: #667eea;
color: white;
border: none;
border-radius: 12px;
font-size: 18px;
cursor: pointer;
transition: all 0.3s;
}
button:hover { background: #556cd6; }
.error {
color: red;
margin-top: 10px;
display: none;
font-weight: 600;
}
.back-button {
display: inline-flex;
align-items: center;
gap: 8px;
margin-top: 20px;
padding: 10px 20px;
background: #f1f5f9;
color: #64748b;
text-decoration: none;
border-radius: 12px;
font-weight: 600;
transition: all 0.3s;
}
.back-button:hover {
background: #e2e8f0;
color: #334155;
}
</style>
</head>
<body>
<div class="card">
<h1>üîë Masuk ke Bus</h1>
<p>Masukkan PIN 6 digit</p>
<input type="text" id="pin" maxlength="6" placeholder="______" onkeypress="if(event.key==='Enter') verifyPin()">
<button onclick="verifyPin()">Masuk</button>
<div class="error" id="error">PIN salah</div>
<a href="index.html" class="back-button">
<span>‚Üê</span>
<span>Kembali ke Pilih Bus</span>
</a>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="js/firebase.js"></script>
<script src="js/room.js"></script>
<script>
// ========= KEAMANAN ANTI-DIRECT LINK =========
// Jika tidak ada parameter room di URL, redirect ke index.html
const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get('room');
if (!roomId) {
  window.location.href = 'index.html';
}

// ========= VERIFIKASI PIN =========
async function verifyPin() {
  let pinInput = document.getElementById('pin').value.trim();
  const errorEl = document.getElementById('error');
  
  if (pinInput.length !== 6 || !/^\d{6}$/.test(pinInput)) {
    errorEl.style.display = 'block';
    return;
  }
  
  // Ubah input jadi number (sesuai Firebase kamu yang simpan sebagai number)
  const pin = Number(pinInput);
  
  // ‚úÖ FIX: Gunakan tanda backtick yang benar untuk template literal
  const pinRef = db.ref(`karaoke/room/${roomId}/Setting/pin`);
  
  try {
    const snap = await pinRef.once('value');
    if (snap.exists() && snap.val() === pin) {
      localStorage.setItem('karaoke_room_id', roomId);
      window.location.href = `bus-menu.html?room=${roomId}`;
    } else {
      errorEl.style.display = 'block';
      document.getElementById('pin').value = '';
      document.getElementById('pin').focus();
      setTimeout(() => { errorEl.style.display = 'none'; }, 3000);
    }
  } catch (e) {
    alert('Gagal memeriksa PIN. Coba lagi.');
    console.error(e);
  }
}
</script>
</body>
</html>